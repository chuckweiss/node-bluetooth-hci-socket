From e4639e0b40c91cb83b4a4f1c9aab900ed73b6f9f Mon Sep 17 00:00:00 2001
From: Marek Serafin <marek@snowheads.pl>
Date: Thu, 2 Nov 2023 13:29:51 +0100
Subject: [PATCH] uart

---
 .../hci_uart/boards/nrf52840dk_nrf52840.conf  |  4 ++
 .../boards/nrf52840dk_nrf52840.overlay        | 18 +++++---
 samples/bluetooth/hci_uart/prj.conf           | 44 ++++++++++++++-----
 3 files changed, 49 insertions(+), 17 deletions(-)
 create mode 100644 samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.conf

diff --git a/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.conf b/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.conf
new file mode 100644
index 0000000000..21d8db7e8b
--- /dev/null
+++ b/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.conf
@@ -0,0 +1,4 @@
+CONFIG_USB_DEVICE_STACK=y
+CONFIG_USB_DEVICE_PRODUCT="Zephyr HCI UART"
+CONFIG_USB_CDC_ACM=y
+CONFIG_USB_DEVICE_INITIALIZE_AT_BOOT=n
diff --git a/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.overlay b/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.overlay
index b3c844493c..f85bef265a 100644
--- a/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.overlay
+++ b/samples/bluetooth/hci_uart/boards/nrf52840dk_nrf52840.overlay
@@ -1,8 +1,16 @@
 /* SPDX-License-Identifier: Apache-2.0 */
 
-&uart0 {
-	compatible = "nordic,nrf-uart";
-	current-speed = <1000000>;
-	status = "okay";
-	hw-flow-control;
+/ {
+	chosen {
+		zephyr,bt-c2h-uart = &cdc_acm_uart0;
+	};
 };
+
+&zephyr_udc0 {
+	cdc_acm_uart0: cdc_acm_uart0 {
+		compatible = "zephyr,cdc-acm-uart";
+		label = "CDC_ACM_0";
+		current-speed = <1000000>;
+		hw-flow-control;
+	};
+};
\ No newline at end of file
diff --git a/samples/bluetooth/hci_uart/prj.conf b/samples/bluetooth/hci_uart/prj.conf
index bdc73dd68e..b35c20e64c 100644
--- a/samples/bluetooth/hci_uart/prj.conf
+++ b/samples/bluetooth/hci_uart/prj.conf
@@ -1,23 +1,43 @@
-CONFIG_CONSOLE=n
+CONFIG_CONSOLE=y
 CONFIG_STDOUT_CONSOLE=n
 CONFIG_UART_CONSOLE=n
-CONFIG_GPIO=y
+CONFIG_GPIO=n
 CONFIG_SERIAL=y
 CONFIG_UART_INTERRUPT_DRIVEN=y
 CONFIG_BT=y
 CONFIG_BT_HCI_RAW=y
 CONFIG_BT_HCI_RAW_H4=y
 CONFIG_BT_HCI_RAW_H4_ENABLE=y
-CONFIG_BT_BUF_ACL_RX_SIZE=255
-CONFIG_BT_BUF_CMD_TX_SIZE=255
-CONFIG_BT_BUF_EVT_DISCARDABLE_SIZE=255
+CONFIG_BT_BUF_EVT_DISCARDABLE_SIZE=251
 CONFIG_BT_CTLR_ASSERT_HANDLER=y
-CONFIG_BT_MAX_CONN=16
+CONFIG_BT_MAX_CONN=5
 CONFIG_BT_TINYCRYPT_ECC=n
 CONFIG_BT_CTLR_DTM_HCI=y
-
-CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=512
-
-# Workaround: Unable to allocate command buffer when using K_NO_WAIT since
-# Host number of completed commands does not follow normal flow control.
-CONFIG_BT_BUF_CMD_TX_COUNT=10
+CONFIG_SYSTEM_WORKQUEUE_STACK_SIZE=24000
+CONFIG_USE_SEGGER_RTT=n
+CONFIG_RTT_CONSOLE=n
+CONFIG_LOG=n
+CONFIG_BT_BUF_CMD_TX_COUNT=64
+CONFIG_BT_BUF_ACL_RX_COUNT=64
+CONFIG_BT_BUF_ACL_TX_COUNT=200
+CONFIG_BT_BUF_EVT_RX_COUNT=255
+#CONFIG_BT_CTLR_DATA_LENGTH_MAX=251
+#CONFIG_BT_CTLR_ISO_TX_BUFFERS=250
+#CONFIG_BT_CTLR_ISO_TX_BUFFER_SIZE=251
+#CONFIG_BT_DATA_LEN_UPDATE=y
+CONFIG_BT_BUF_ACL_RX_SIZE=251
+CONFIG_BT_BUF_ACL_TX_SIZE=251
+CONFIG_BT_BUF_CMD_TX_SIZE=251
+CONFIG_BT_BUF_EVT_RX_SIZE=251
+CONFIG_BT_CTLR=y
+CONFIG_BT_LL_SW_SPLIT=y
+CONFIG_BT_CTLR_CRYPTO=y
+CONFIG_BT_CTLR_LE_ENC=y
+CONFIG_BT_CTLR_PRIVACY=y
+CONFIG_BT_CTLR_FILTER_ACCEPT_LIST=y
+CONFIG_BT_CTLR_DTM_HCI=y
+CONFIG_BT_CTLR_ADVANCED_FEATURES=y
+CONFIG_BT_CTLR_PARAM_CHECK=y
+CONFIG_BT_CTLR_PROFILE_ISR=y
+#CONFIG_BT_BUF_EVT_DISCARDABLE_COUNT=200
+CONFIG_BT_BUF_EVT_DISCARDABLE_SIZE=251
\ No newline at end of file
-- 
2.39.3 (Apple Git-145)

